---
// Acerca.astro - Componente de galería con parallax y texto fijo
// Importar las imágenes locales
import img1 from "@/assets/motorsport/s14/1.png";
import img2 from "@/assets/motorsport/s14/2.png";
import img3 from "@/assets/motorsport/s14/3.png";
import img4 from "@/assets/motorsport/s14/4.png";
import img5 from "@/assets/motorsport/s14/5.png";
import img6 from "@/assets/motorsport/s14/6.png";
import img7 from "@/assets/motorsport/s14/7.png";
import img8 from "@/assets/motorsport/s14/8.png";
import img9 from "@/assets/motorsport/s14/9.png";
---

<section class="acerca-section">
  <div class="acerca-container">
    <div class="images-column">
      <div class="images">
        <img data-speed="0.8" src={img1.src} alt="Motorsport S14 1" />
        <img data-speed="0.9" src={img2.src} alt="Motorsport S14 2" />
        <img data-speed="1" src={img3.src} alt="Motorsport S14 3" />
        <img data-speed="1.1" src={img4.src} alt="Motorsport S14 4" />
        <img data-speed="0.9" src={img5.src} alt="Motorsport S14 5" />
        <img data-speed="1.2" src={img6.src} alt="Motorsport S14 6" />
        <img data-speed="0.8" src={img7.src} alt="Motorsport S14 7" />
        <img data-speed="1" src={img8.src} alt="Motorsport S14 8" />
        <img data-speed="1.1" src={img9.src} alt="Motorsport S14 9" />
      </div>
    </div>

    <div class="text-column">
      <div class="text-sticky">
        <div class="line-mask">
          <h2 class="title">El inicio de una leyenda</h2>
        </div>
        <div class="line-mask">
          <p class="description">
            Este no es solo un carro. Es la prueba de que un chavo que lavaba
            coches a los 14 años puede construir sus propios sueños.
          </p>
        </div>
        <div class="line-mask">
          <p class="description">
            Kenyi Nakamura y su equipo convirtieron un S14 naranja en una obra
            de arte Midnight Purple. Pura dedicación.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";
  import { ScrollSmoother } from "gsap/ScrollSmoother";

  gsap.registerPlugin(ScrollTrigger, ScrollSmoother);

  function initAcercaEffects() {
    const smoother = ScrollSmoother.get();

    if (!smoother) {
      console.warn("ScrollSmoother no encontrado. Reintentando en 100ms...");
      setTimeout(initAcercaEffects, 100);
      return;
    }

    console.log(
      "✅ ScrollSmoother encontrado, aplicando efectos responsivos...",
    );

    ScrollTrigger.matchMedia({
      // --- VISTA DE ESCRITORIO (1025px y más) ---
      "(min-width: 1025px)": function () {
        console.log("Activando animaciones de escritorio.");

        // 1. Efecto de pin para el texto
        const pin = ScrollTrigger.create({
          trigger: ".acerca-section",
          pin: ".text-sticky",
          start: "top 20%",
          endTrigger: ".images",
          end: "bottom bottom",
        });

        // 2. Efecto de velocidad (parallax) en las imágenes
        const images = document.querySelectorAll(".images-column img");
        images.forEach((img) => {
          const speed = img.getAttribute("data-speed");
          if (speed) {
            gsap.to(img, {
              y: () =>
                (1 - parseFloat(speed)) * ScrollTrigger.maxScroll(window) * 0.1,
              ease: "none",
              scrollTrigger: {
                start: "top bottom",
                end: "bottom top",
                scrub: 0.5,
                invalidateOnRefresh: true,
              },
            });
          }
        });

        // 3. Efecto skew basado en la velocidad del scroll
        let skewSetter = gsap.quickTo(".images-column img", "skewY");
        let clamp = gsap.utils.clamp(-20, 20);

        let rafId;
        const updateSkew = () => {
          const velocity = smoother.getVelocity();
          skewSetter(clamp(velocity / -50));
          rafId = requestAnimationFrame(updateSkew);
        };
        updateSkew();

        // --- ✨ NUEVO: Efecto de revelado de texto ---
        const textElements = gsap.utils.toArray(".line-mask > *");

        gsap.from(textElements, {
          yPercent: 100, // Empieza 100% abajo (fuera de la máscara)
          opacity: 0,
          stagger: 0.2, // Anima cada elemento con un pequeño retraso
          duration: 1,
          ease: "power3.out",
          scrollTrigger: {
            trigger: ".text-sticky",
            start: "top 80%", // La animación empieza cuando el contenedor de texto está al 80% del viewport
            toggleActions: "play none none reverse", // Se reproduce al entrar, se revierte al salir por arriba
          },
        });
        // --- FIN DEL CÓDIGO NUEVO ---

        return () => {
          console.log("Limpiando animaciones de escritorio.");
          if (pin) pin.kill();
          if (rafId) cancelAnimationFrame(rafId);
        };
      },

      // --- VISTA MÓVIL (1024px y menos) ---
      "(max-width: 1024px)": function () {
        console.log('Vista móvil. No se aplica "pin" al texto.');
      },
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAcercaEffects);
  } else {
    initAcercaEffects();
  }
</script>

<style>
  .acerca-section {
    position: relative;
    width: 100%;
    min-height: 100vh;
    background: #000;
    padding-top: 10vh;
    overflow: hidden;
  }
  .acerca-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  .images-column {
    position: relative;
  }
  .images {
    position: relative;
    width: 100%;
    min-height: 200vh;
    display: grid;
    grid-template-columns: repeat(10, 10%);
    grid-template-rows: repeat(30, 5vh);
    gap: 0;
  }
  img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    will-change: transform;
    border-radius: 4px;
  }
  /* Grid areas para las imágenes */
  img:nth-child(1) {
    grid-area: 1 / 1 / 6 / 6;
  }
  img:nth-child(2) {
    grid-area: 3 / 6 / 8 / 11;
  }
  img:nth-child(3) {
    grid-area: 9 / 2 / 13 / 9;
  }
  img:nth-child(4) {
    grid-area: 14 / 1 / 18 / 6;
  }
  img:nth-child(5) {
    grid-area: 16 / 6 / 20 / 11;
  }
  img:nth-child(6) {
    grid-area: 20 / 2 / 25 / 7;
  }
  img:nth-child(7) {
    grid-area: 22 / 7 / 26 / 11;
  }
  img:nth-child(8) {
    grid-area: 26 / 3 / 30 / 9;
  }
  img:nth-child(9) {
    grid-area: 28 / 1 / 31 / 6;
  }

  .text-column {
    position: relative;
  }
  .text-sticky {
    height: fit-content;
    padding: 2rem;
  }

  /* --- ✨ NUEVO: Estilos para la máscara de texto --- */
  .line-mask {
    overflow: hidden; /* Oculta el texto que se sale */
    margin-bottom: 2rem; /* Mantiene el espaciado original del título */
  }
  .line-mask:last-child {
    margin-bottom: 0;
  }
  .line-mask p {
    margin-bottom: 0;
  }
  /* --- FIN DE LOS NUEVOS ESTILOS --- */

  .title {
    font-family: termina, sans-serif;
    font-weight: 900;
    font-style: normal;
    font-size: clamp(2.5rem, 5vw, 4rem);
    color: white;
    margin: 0;
    line-height: 1.1;
    -webkit-text-stroke-width: 1.5px;
    -webkit-text-stroke-color: white;
  }
  .description {
    font-family:
      system-ui,
      -apple-system,
      sans-serif;
    font-size: clamp(1rem, 1.5vw, 1.25rem);
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.6;
    margin-bottom: 1.5rem; /* Este margen se controla ahora con .line-mask */
  }

  /* --- MEDIA QUERIES PARA RESPONSIVE --- */

  /* Tablet y móvil */
  @media (max-width: 1024px) {
    .acerca-container {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    .text-column {
      order: -1;
    }
    .text-sticky {
      position: static;
      padding-top: 0;
    }
    .images {
      min-height: 150vh;
    }
  }

  /* Móvil pequeño */
  @media (max-width: 768px) {
    .acerca-container {
      padding: 0 1rem;
    }
    .images {
      grid-template-columns: repeat(8, 12.5%);
      min-height: 120vh;
    }
    /* Reajuste del grid de imágenes */
    img:nth-child(1) {
      grid-area: 1 / 1 / 5 / 5;
    }
    img:nth-child(2) {
      grid-area: 3 / 5 / 7 / 9;
    }
    img:nth-child(3) {
      grid-area: 8 / 2 / 12 / 7;
    }
    img:nth-child(4) {
      grid-area: 13 / 1 / 17 / 5;
    }
    img:nth-child(5) {
      grid-area: 15 / 5 / 19 / 9;
    }
    img:nth-child(6) {
      grid-area: 20 / 2 / 24 / 6;
    }
    img:nth-child(7) {
      grid-area: 22 / 6 / 26 / 9;
    }
    img:nth-child(8) {
      grid-area: 27 / 3 / 31 / 7;
    }
    img:nth-child(9) {
      grid-area: 29 / 1 / 32 / 5;
    }
  }
</style>
