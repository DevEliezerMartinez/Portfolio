---
// Welcome.astro - Sección con reveal de texto y parallax de imágenes
import img1 from '@/assets/motorsport/s14/1.png';
import img2 from '@/assets/motorsport/s14/2.png';
import img3 from '@/assets/motorsport/s14/3.png';
import img4 from '@/assets/motorsport/s14/4.png';
import img5 from '@/assets/motorsport/s14/5.png';
import img6 from '@/assets/motorsport/s14/6.png';
import img7 from '@/assets/motorsport/s14/7.png';
import img8 from '@/assets/motorsport/s14/8.png';
import img9 from '@/assets/motorsport/s14/9.png';
---

<section class="welcome-section relative w-full min-h-[250vh] bg-black">
  
  <!-- Contenedor de imágenes parallax (izquierda) -->
  <div class="parallax-wrapper sticky top-0 left-0 h-screen w-1/2 lg:w-[45%] float-left pointer-events-none overflow-hidden">
    <div class="parallax-track">
      <div class="parallax-item" data-speed="0.6">
        <img src={img1.src} alt="Motorsport S14 1" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="0.7">
        <img src={img2.src} alt="Motorsport S14 2" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="0.8">
        <img src={img3.src} alt="Motorsport S14 3" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="0.9">
        <img src={img4.src} alt="Motorsport S14 4" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="1">
        <img src={img5.src} alt="Motorsport S14 5" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="1.1">
        <img src={img6.src} alt="Motorsport S14 6" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="1.2">
        <img src={img7.src} alt="Motorsport S14 7" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="1.3">
        <img src={img8.src} alt="Motorsport S14 8" class="parallax-img">
      </div>
      <div class="parallax-item" data-speed="1.4">
        <img src={img9.src} alt="Motorsport S14 9" class="parallax-img">
      </div>
    </div>
  </div>

  <!-- Contenido de texto (derecha) -->
  <div class="welcome-content sticky top-0 h-screen w-1/2 lg:w-[55%] ml-auto flex flex-col justify-center px-8 md:px-12 lg:px-16 xl:px-20">
    <h2 class="welcome-text text-3xl md:text-4xl lg:text-5xl font-light leading-tight text-white max-w-3xl">
      <span class="reveal-line">Este no es solo un carro.</span>
      <span class="reveal-line">Es la prueba de que un chavo</span>
      <span class="reveal-line">que lavaba coches a los 14 años</span>
      <span class="reveal-line">puede <span class="text-gray-600">construir sus propios sueños.</span></span>
      <span class="reveal-line">Kenyi Nakamura <span class="text-gray-600">y su equipo convirtieron</span></span>
      <span class="reveal-line">un S14 naranja <span class="text-gray-600">en una obra de arte</span></span>
      <span class="reveal-line">Midnight Purple. <span class="text-gray-600">Pura dedicación.</span></span>
    </h2>
  </div>
</section>

<style>
  .welcome-section {
    isolation: isolate;
  }

  .reveal-line {
    display: block;
    opacity: 0;
    transform: translateY(30px);
    margin-bottom: 1.9rem;
  }

  .reveal-line .text-gray-600 {
    color: #4b5563;
  }

  .parallax-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .parallax-track {
    position: relative;
    width: 100%;
    max-width: 400px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    padding: 2rem 1rem;
  }

  .parallax-item {
    width: 100%;
    flex-shrink: 0;
    will-change: transform;
  }

  .parallax-img {
    width: 100%;
    height: auto;
    aspect-ratio: 4/5;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    display: block;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .parallax-wrapper {
      width: 40%;
    }

    .welcome-content {
      width: 60%;
    }
  }

  @media (max-width: 768px) {
    .parallax-wrapper {
      display: none;
    }

    .welcome-content {
      margin-left: 0;
      width: 100%;
      padding-left: 2rem;
      padding-right: 2rem;
    }

    .welcome-text {
      font-size: 2rem;
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  function initWelcomeAnimation() {
    const section = document.querySelector('.welcome-section');
    const lines = document.querySelectorAll('.welcome-section .reveal-line');
    const items = document.querySelectorAll('.parallax-item');

    if (!section || !lines.length || !items.length) return;

    // Animación de texto con scroll trigger
    gsap.to(lines, {
      opacity: 1,
      y: 0,
      duration: 1,
      stagger: 0.15,
      ease: "power2.out",
      scrollTrigger: {
        trigger: section,
        start: 'top 80%',
        end: 'top 20%',
        toggleActions: 'play none none reverse',
      }
    });

    // Parallax individual para cada item
    items.forEach((item, index) => {
      const speed = parseFloat(item.getAttribute('data-speed') || '1');
      const movement = (speed - 1) * 500;
      
      gsap.fromTo(item, 
        {
          y: movement + 200, // Empiezan más abajo
          opacity: index < 3 ? 1 : 0 // Solo las primeras 3 visibles
        },
        {
          y: -movement - 200, // Terminan más arriba
          opacity: 1,
          ease: "none",
          scrollTrigger: {
            trigger: section,
            start: 'top bottom',
            end: 'bottom top',
            scrub: 1.5,
          }
        }
      );
    });

    // Skew effect en las imágenes con velocidad del scroll
    const images = document.querySelectorAll('.parallax-img');
    const skewSetter = gsap.quickTo(images, "skewY", {
      duration: 0.5,
      ease: "power3.out"
    });
    const clamp = gsap.utils.clamp(-15, 15);

    ScrollTrigger.create({
      trigger: section,
      start: 'top bottom',
      end: 'bottom top',
      onUpdate: (self) => {
        const velocity = self.getVelocity();
        skewSetter(clamp(velocity / -100));
      },
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initWelcomeAnimation);
  } else {
    initWelcomeAnimation();
  }

  // Refresh ScrollTrigger on resize
  let resizeTimer: number;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      ScrollTrigger.refresh();
    }, 250);
  });
</script>